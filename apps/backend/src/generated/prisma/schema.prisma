// Better Auth: Account model (https://better-auth.com/docs/adapters/prisma)
model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
  @@schema("better_auth")
}

// Better Auth: API Key plugin (https://better-auth.com/docs/plugins/api-key)
model ApiKey {
  id                  String    @id
  name                String?
  start               String?
  prefix              String?
  key                 String
  userId              String
  refillInterval      Int?
  refillAmount        Int?
  lastRefillAt        DateTime?
  enabled             Boolean   @default(true)
  rateLimitEnabled    Boolean   @default(true)
  rateLimitTimeWindow Int?
  rateLimitMax        Int?
  requestCount        Int       @default(0)
  remaining           Int?
  lastRequest         DateTime?
  expiresAt           DateTime?
  createdAt           DateTime
  updatedAt           DateTime
  permissions         String?
  metadata            String?

  @@map("apikey")
  @@schema("better_auth")
}

// Better Auth: Organization plugin - Invitation (https://better-auth.com/docs/plugins/organization)
model Invitation {
  id             String       @id
  email          String
  inviterId      String
  organizationId String
  role           String
  status         String
  createdAt      DateTime
  expiresAt      DateTime
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invitation")
  @@schema("better_auth")
}

// Better Auth: Organization plugin - Member (https://better-auth.com/docs/plugins/organization)
model Member {
  id             String       @id
  userId         String
  organizationId String
  role           String
  createdAt      DateTime
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("member")
  @@schema("better_auth")
}

// Better Auth: Organization plugin (https://better-auth.com/docs/plugins/organization)
model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  metadata    String?
  createdAt   DateTime
  members     Member[]
  invitations Invitation[]

  @@unique([slug])
  @@map("organization")
  @@schema("better_auth")
}

// Better Auth: Session model (https://better-auth.com/docs/adapters/prisma)
// Organization plugin: activeOrganizationId, activeTeamId (https://better-auth.com/docs/plugins/organization)
// Admin plugin: impersonatedBy (https://better-auth.com/docs/plugins/admin)
model Session {
  id                   String   @id
  expiresAt            DateTime
  token                String
  createdAt            DateTime
  updatedAt            DateTime
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activeOrganizationId String?
  activeTeamId         String?
  // Admin plugin field
  impersonatedBy       String?

  @@unique([token])
  @@map("session")
  @@schema("better_auth")
}

// Better Auth: SSO plugin (https://www.better-auth.com/docs/plugins/sso#schema)
model SsoProvider {
  id             String  @id
  issuer         String
  domain         String
  oidcConfig     String?
  samlConfig     String?
  userId         String
  providerId     String
  organizationId String?
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId])
  @@map("ssoprovider")
  @@schema("better_auth")
}

// Better Auth: User model (https://better-auth.com/docs/adapters/prisma)
// Admin plugin: role, banned, banReason, banExpires (https://better-auth.com/docs/plugins/admin)
model User {
  id            String        @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]
  members       Member[]
  ssoProviders  SsoProvider[]
  // Admin plugin fields
  role          String?
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?

  @@unique([email])
  @@map("user")
  @@schema("better_auth")
}

// Better Auth: Verification model (https://better-auth.com/docs/adapters/prisma)
model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
  @@schema("better_auth")
}

// App: env config per organization (org = project). Public schema.
model OrganizationEnv {
  id             String   @id @default(cuid())
  organizationId String // org id from better_auth.organization
  env            String // "development" | "staging" | "production"
  baseUrl        String?
  apiKey         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, env])
  @@map("organization_env")
  @@schema("public")
}

// Ingest: One row per API hit (HTTP request). App logs for that request are stored in appLogs array.
model Logger {
  id             String   @id @default(cuid())
  organizationId String
  env            String // "development" | "staging" | "production"
  type           String // "http"
  tracingId      String
  requestId      String?
  timestamp      DateTime
  createdAt      DateTime @default(now())
  // HTTP log fields
  method         String?
  route          String?
  statusCode     Int?
  durationMs     Int?
  responseSize   Int?
  // App logs for this request. Array of { level, message?, payload?, timestamp? }.
  appLogs        Json? // [{ level, message?, payload?, timestamp? }, ...]

  @@index([organizationId, env])
  @@index([organizationId, env, type])
  @@index([organizationId, env, tracingId])
  @@index([organizationId, env, timestamp])
  @@map("logger")
  @@schema("public")
}

// Aggregated stats for dashboard (updated async on ingest; not blocking).
model DashboardSnapshot {
  id               String   @id @default(cuid())
  organizationId   String
  env              String
  totalHttpLogs    Int      @default(0)
  successCount     Int      @default(0)
  clientErrorCount Int      @default(0)
  serverErrorCount Int      @default(0)
  totalRoutes      Int      @default(0)
  updatedAt        DateTime @updatedAt

  @@unique([organizationId, env])
  @@map("dashboard_snapshot")
  @@schema("public")
}

// Ingest: API explorer JSON from SDK (route tree / tracelet.doc.json resolved per project/env).
model ApiExplorerSnapshot {
  id             String   @id @default(cuid())
  organizationId String
  env            String
  data           Json // TraceletMeta[] or route tree from @tracelet/core
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, env])
  @@map("api_explorer_snapshot")
  @@schema("public")
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  schemas  = ["better_auth", "public"]
}
